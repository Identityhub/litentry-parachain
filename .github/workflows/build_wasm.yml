name: Build wasm

on:
  workflow_dispatch:
    inputs:
      ref:
        description: The ref to be used for the repo
        default: dev
        required: false
  push:
    tags:
      - "*"

env:
  CARGO_TERM_COLOR: always

jobs:
  build-wasm:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout codes on ${{ github.event.inputs.ref || github.ref }}
        uses: actions/checkout@v2
        with:
          ref: ${{ github.event.inputs.ref || github.ref }}

      - name: Build with srtool
        id: srtool_build
        uses: chevdor/srtool-actions@v0.3.0
        with:
          chain: litentry-parachain
          runtime_dir: runtime

      - name: Summary
        run: |
          echo '${{ steps.srtool_build.outputs.json }}' | jq . > litentry-parachain-srtool-digest.json
          cat ${{ matrix.chain }}-srtool-digest.json
          echo "==============================================="
          echo "compact runtime:            ${{ steps.srtool_build.outputs.wasm }}"
          echo "compact compressed runtime: ${{ steps.srtool_build.outputs.wasm_compressed }}"

      - name: Archive artefacts
        uses: actions/upload-artifact@v2
        with:
          name: litentry-parachain-runtime
          path: |
            litentry-parachain-srtool-digest.json
            ${{ steps.srtool_build.outputs.wasm_compressed }}
            ${{ steps.srtool_build.outputs.wasm }}