// Copyright 2020-2024 Trust Computing GmbH.
// This file is part of Litentry.
//
// Litentry is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// Litentry is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with Litentry.  If not, see <https://www.gnu.org/licenses/>.

#[cfg(all(feature = "std", feature = "sgx"))]
compile_error!("feature \"std\" and feature \"sgx\" cannot be enabled at the same time");

#[cfg(all(not(feature = "std"), feature = "sgx"))]
extern crate sgx_tstd as std;

#[cfg(all(not(feature = "std"), feature = "sgx"))]
extern crate hex_sgx as hex;

use primitive_types::H160;
use std::{collections::HashMap, vec::Vec};

pub trait SmartContractRepository {
	fn get(&self, id: &H160) -> Option<Vec<u8>>;
}

pub struct InMemorySmartContractRepo {
	map: HashMap<H160, Vec<u8>>,
}

impl InMemorySmartContractRepo {
	pub fn new() -> Self {
		let mut map = HashMap::new();
		//a1
		map.insert(
            hash(0),
            hex::decode("608060405234801561001057600080fd5b50610af9806100206000396000f3fe608060405234801561001057600080fd5b506004361061002b5760003560e01c806309c5eabe14610030575b600080fd5b61004361003e366004610589565b61005d565b604051610054959493929190610665565b60405180910390f35b6060806060806000808680602001905181019061007a91906107b9565b905061008581610098565b939b929a50909850965090945092505050565b60608060608060008060405180608001604052806045815260200161098b60459139604080518082018252601b81527f4261736963204964656e7469747920566572696669636174696f6e000000000060208083019190915260008054600181018255818052845160c08101909552608180865295965092947f290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e56390930193909290916109d0908301398051610154939250602090910190610458565b506040518060a0016040528060738152602001610a5160739139805161018291600191602090910190610458565b5060008080805b8b51811015610200576101b48c82815181106101a7576101a7610910565b602002602001015161038b565b156101c257600191506101ee565b6101e48c82815181106101d7576101d7610910565b60200260200101516103ba565b156101ee57600192505b806101f881610926565b915050610189565b5080801561020b5750815b92508484600060018682805480602002602001604051908101604052809291908181526020016000905b828210156102e15783829060005260206000200180546102549061094f565b80601f01602080910402602001604051908101604052809291908181526020018280546102809061094f565b80156102cd5780601f106102a2576101008083540402835291602001916102cd565b820191906000526020600020905b8154815290600101906020018083116102b057829003601f168201915b505050505081526020019060010190610235565b5050505092508180546102f39061094f565b80601f016020809104026020016040519081016040528092919081815260200182805461031f9061094f565b801561036c5780601f106103415761010080835404028352916020019161036c565b820191906000526020600020905b81548152906001019060200180831161034f57829003601f168201915b5050505050915099509950995099509950505050505091939590929450565b6000610396826103e3565b806103a557506103a5826103f0565b806103b457506103b4826103fd565b92915050565b60006103c58261040a565b806103d457506103d482610417565b806103b457506103b482610424565b60006103b482600061042d565b60006103b482600161042d565b60006103b482600261042d565b60006103b482600361042d565b60006103b482600461042d565b60006103b48260055b60008163ffffffff16836000015163ffffffff16141561044f575060016103b4565b50600092915050565b8280546104649061094f565b90600052602060002090601f01602090048101928261048657600085556104cc565b82601f1061049f57805160ff19168380011785556104cc565b828001600101855582156104cc579182015b828111156104cc5782518255916020019190600101906104b1565b506104d89291506104dc565b5090565b5b808211156104d857600081556001016104dd565b634e487b7160e01b600052604160045260246000fd5b6040516060810167ffffffffffffffff8111828210171561052a5761052a6104f1565b60405290565b604051601f8201601f1916810167ffffffffffffffff81118282101715610559576105596104f1565b604052919050565b600067ffffffffffffffff82111561057b5761057b6104f1565b50601f01601f191660200190565b60006020828403121561059b57600080fd5b813567ffffffffffffffff8111156105b257600080fd5b8201601f810184136105c357600080fd5b80356105d66105d182610561565b610530565b8181528560208385010111156105eb57600080fd5b81602084016020830137600091810160200191909152949350505050565b60005b8381101561062457818101518382015260200161060c565b83811115610633576000848401525b50505050565b60008151808452610651816020860160208601610609565b601f01601f19169290920160200192915050565b60a08152600061067860a0830188610639565b60208382038185015261068b8289610639565b915083820360408501528187518084528284019150828160051b850101838a0160005b838110156106dc57601f198784030185526106ca838351610639565b948601949250908501906001016106ae565b505086810360608801526106f0818a610639565b95505050505050610705608083018415159052565b9695505050505050565b600067ffffffffffffffff821115610729576107296104f1565b5060051b60200190565b805163ffffffff8116811461074757600080fd5b919050565b600082601f83011261075d57600080fd5b8151602061076d6105d18361070f565b82815260059290921b8401810191818101908684111561078c57600080fd5b8286015b848110156107ae576107a181610733565b8352918301918301610790565b509695505050505050565b600060208083850312156107cc57600080fd5b825167ffffffffffffffff808211156107e457600080fd5b818501915085601f8301126107f857600080fd5b81516108066105d18261070f565b81815260059190911b8301840190848101908883111561082557600080fd5b8585015b838110156109035780518581111561084057600080fd5b86016060818c03601f190112156108575760008081fd5b61085f610507565b61086a898301610733565b8152604080830151888111156108805760008081fd5b8301603f81018e136108925760008081fd5b8a8101516108a26105d182610561565b8181528f848385010111156108b75760008081fd5b6108c6828e8301868601610609565b848d015250506060830151888111156108df5760008081fd5b6108ed8e8c8387010161074c565b9183019190915250845250918601918601610829565b5098975050505050505050565b634e487b7160e01b600052603260045260246000fd5b600060001982141561094857634e487b7160e01b600052601160045260246000fd5b5060010190565b600181811c9082168061096357607f821691505b6020821081141561098457634e487b7160e01b600052602260045260246000fd5b5091905056fe596f75277665206964656e746966696564206174206c65617374206f6e65206163636f756e742f6164647265737320696e20626f7468205765623220616e6420576562332e7b22616e64223a205b7b2022737263223a2022246861735f776562325f6163636f756e74222c20226f70223a20223d3d222c2022647374223a20227472756522207d2c207b2022737263223a2022246861735f776562335f6163636f756e74222c20226f70223a20223d3d222c2022647374223a20227472756522207d205d207d68747470733a2f2f7261772e67697468756275736572636f6e74656e742e636f6d2f6c6974656e7472792f76632d6a736f6e736368656d612f6d61696e2f646973742f736368656d61732f312d62617369632d6964656e746974792d766572696669636174696f6e2f312d302d302e6a736f6ea26469706673582212204f3a01d6e795ee4a8254e45b22b9213130a0ec68cb54371e4bf23de373793fae64736f6c63430008080033").unwrap()
        );
		//a20
		map.insert(
			hash(1),
			hex::decode("608060405234801561001057600080fd5b50610c77806100206000396000f3fe608060405234801561001057600080fd5b506004361061002b5760003560e01c806309c5eabe14610030575b600080fd5b61004361003e366004610657565b61005d565b604051610054959493929190610733565b60405180910390f35b6060806060806000808680602001905181019061007a9190610887565b905061008581610098565b939b929a50909850965090945092505050565b6060806060806000806040518060c0016040528060868152602001610b4560869139604080518082018252601c81527f49444875622045564d2056657273696f6e204561726c7920426972640000000060208083019190915260008054600181018255818052845160608101909552603380865295965092947f290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e5639093019390929091610bcb908301398051610154939250602090910190610526565b506040518060a0016040528060758152602001610ad060759139805161018291600191602090910190610526565b506000805b8951811015610259576101b28a82815181106101a5576101a56109de565b60200260200101516103d6565b156102475760006101df8b83815181106101ce576101ce6109de565b602002602001015160200151610405565b90506000610205604051806080016040528060448152602001610bfe6044913983610450565b60408051808201909152600a8152690bda185cd29bda5b995960b21b6020820152909150610233828261047f565b9450841561024357505050610259565b5050505b80610251816109f4565b915050610187565b508282600060018482805480602002602001604051908101604052809291908181526020016000905b8282101561032e5783829060005260206000200180546102a190610a1d565b80601f01602080910402602001604051908101604052809291908181526020018280546102cd90610a1d565b801561031a5780601f106102ef5761010080835404028352916020019161031a565b820191906000526020600020905b8154815290600101906020018083116102fd57829003601f168201915b505050505081526020019060010190610282565b50505050925081805461034090610a1d565b80601f016020809104026020016040519081016040528092919081815260200182805461036c90610a1d565b80156103b95780601f1061038e576101008083540402835291602001916103b9565b820191906000526020600020905b81548152906001019060200180831161039c57829003601f168201915b505050505091509750975097509750975050505091939590929450565b60006103e1826104d9565b806103f057506103f0826104e6565b806103ff57506103ff826104f3565b92915050565b606060008260405160200161041a9190610a58565b60408051601f1981840301815291905280519091506082838260208501600061041b600019f161044957600080fd5b5050919050565b606060008383604051602001610467929190610a72565b60408051808303601f19018152919052949350505050565b60008060008484604051602001610497929190610aa1565b60408051601f19818403018152908290528051909250906020818382860160006103e9600019f16104c757600080fd5b60208101604052519695505050505050565b60006103ff8260036104fc565b60006103ff8260046104fc565b60006103ff8260055b60008163ffffffff16836000015163ffffffff16141561051e575060016103ff565b5060006103ff565b82805461053290610a1d565b90600052602060002090601f016020900481019282610554576000855561059a565b82601f1061056d57805160ff191683800117855561059a565b8280016001018555821561059a579182015b8281111561059a57825182559160200191906001019061057f565b506105a69291506105aa565b5090565b5b808211156105a657600081556001016105ab565b634e487b7160e01b600052604160045260246000fd5b6040516060810167ffffffffffffffff811182821017156105f8576105f86105bf565b60405290565b604051601f8201601f1916810167ffffffffffffffff81118282101715610627576106276105bf565b604052919050565b600067ffffffffffffffff821115610649576106496105bf565b50601f01601f191660200190565b60006020828403121561066957600080fd5b813567ffffffffffffffff81111561068057600080fd5b8201601f8101841361069157600080fd5b80356106a461069f8261062f565b6105fe565b8181528560208385010111156106b957600080fd5b81602084016020830137600091810160200191909152949350505050565b60005b838110156106f25781810151838201526020016106da565b83811115610701576000848401525b50505050565b6000815180845261071f8160208601602086016106d7565b601f01601f19169290920160200192915050565b60a08152600061074660a0830188610707565b6020838203818501526107598289610707565b915083820360408501528187518084528284019150828160051b850101838a0160005b838110156107aa57601f19878403018552610798838351610707565b9486019492509085019060010161077c565b505086810360608801526107be818a610707565b955050505050506107d3608083018415159052565b9695505050505050565b600067ffffffffffffffff8211156107f7576107f76105bf565b5060051b60200190565b805163ffffffff8116811461081557600080fd5b919050565b600082601f83011261082b57600080fd5b8151602061083b61069f836107dd565b82815260059290921b8401810191818101908684111561085a57600080fd5b8286015b8481101561087c5761086f81610801565b835291830191830161085e565b509695505050505050565b6000602080838503121561089a57600080fd5b825167ffffffffffffffff808211156108b257600080fd5b818501915085601f8301126108c657600080fd5b81516108d461069f826107dd565b81815260059190911b830184019084810190888311156108f357600080fd5b8585015b838110156109d15780518581111561090e57600080fd5b86016060818c03601f190112156109255760008081fd5b61092d6105d5565b610938898301610801565b81526040808301518881111561094e5760008081fd5b8301603f81018e136109605760008081fd5b8a81015161097061069f8261062f565b8181528f848385010111156109855760008081fd5b610994828e83018686016106d7565b848d015250506060830151888111156109ad5760008081fd5b6109bb8e8c8387010161081a565b91830191909152508452509186019186016108f7565b5098975050505050505050565b634e487b7160e01b600052603260045260246000fd5b6000600019821415610a1657634e487b7160e01b600052601160045260246000fd5b5060010190565b600181811c90821680610a3157607f821691505b60208210811415610a5257634e487b7160e01b600052602260045260246000fd5b50919050565b602081526000610a6b6020830184610707565b9392505050565b60008351610a848184602088016106d7565b835190830190610a988183602088016106d7565b01949350505050565b604081526000610ab46040830185610707565b8281036020840152610ac68185610707565b9594505050505056fe68747470733a2f2f7261772e67697468756275736572636f6e74656e742e636f6d2f6c6974656e7472792f76632d6a736f6e736368656d612f6d61696e2f646973742f736368656d61732f31322d69646875622d65766d2d76657273696f6e2d6561726c792d626972642f312d302d302e6a736f6e546865207573657220697320616e206561726c7920626972642075736572206f6620746865204964656e746974794875622045564d2076657273696f6e20616e64206861732067656e657261746564206174206c6561737420312063726564656e7469616c20647572696e672032303233204175672031347468207e2041756720323173742e7b2022737263223a2022246861735f6a6f696e6564222c20226f70223a20223d3d222c2022647374223a20227472756522207d687474703a2f2f6c6f63616c686f73743a31393532372f6576656e74732f646f65732d757365722d6a6f696e65642d65766d2d63616d706169676e3f6163636f756e743da2646970667358221220e2dae4f038433d824294b852e1d2e2491c81c250c1167f63c3b954188c89e91d64736f6c63430008080033").unwrap()
		);
		//a6
		map.insert(
			hash(2),
			hex::decode("608060405234801561001057600080fd5b50610e1a806100206000396000f3fe608060405234801561001057600080fd5b506004361061002b5760003560e01c80638efdc15d14610030575b600080fd5b61004361003e366004610a18565b61005d565b604051610054959493929190610ad8565b60405180910390f35b6060808080600080806040519080825280602002602001820160405280156100c157816020015b6100ae6040518060600160405280600063ffffffff16815260200160608152602001606081525090565b8152602001906001900390816100845790505b506040805160028082526060820190925291925060009190816020015b60608152602001906001900390816100de579050509050888160008151811061010957610109610b82565b6020026020010181905250878160018151811061012857610128610b82565b602002602001018190525061013d8282610152565b939d929c50909a509850909650945050505050565b6060806060806000808660008151811061016e5761016e610b82565b6020026020010151905060008760018151811061018d5761018d610b82565b602002602001015190506040518060a0016040528060738152602001610d396073913980516101c4916001916020909101906108e5565b50600080805b8b518110156102ce576101f58c82815181106101e8576101e8610b82565b6020026020010151610621565b156102bc57600061023b6040518060600160405280602b8152602001610cd7602b91398e848151811061022a5761022a610b82565b602002602001015160200151610634565b9050600061027e826040518060400160405280601b81526020017f3f757365722e6669656c64733d7075626c69635f6d6574726963730000000000815250610634565b90506000604051806060016040528060248152602001610cb360249139905060006102a98383610663565b90506102b58187610bae565b9550505050505b806102c681610bff565b9150506101ca565b5060008060008360070b121580156102ea575060018360070b13155b156102fb57506000905060016103c6565b60018360070b138015610312575060648360070b13155b1561032357506001905060646103c6565b60648360070b13801561033b57506103e88360070b13155b1561034d5750606490506103e86103c6565b6103e88360070b13801561036657506127108360070b13155b1561037957506103e890506127106103c6565b6127108360070b1380156103935750620186a08360070b13155b156103a757506127109050620186a06103c6565b620186a08360070b13156103c65750620186a09050677fffffffffffffff5b6001935060006103f9604051806060016040528060398152602001610dac603991396103f48560070b6106bd565b610634565b905061041d81604051806060016040528060378152602001610d0260379139610634565b905061042f816103f48460070b6106bd565b905061045a816040518060400160405280600781526020016622207d205d207d60c81b815250610634565b60008054600181018255908052815191925061049f917f290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e5639091019060208401906108e5565b508686600060018882805480602002602001604051908101604052809291908181526020016000905b828210156105745783829060005260206000200180546104e790610c1a565b80601f016020809104026020016040519081016040528092919081815260200182805461051390610c1a565b80156105605780601f1061053557610100808354040283529160200191610560565b820191906000526020600020905b81548152906001019060200180831161054357829003601f168201915b5050505050815260200190600101906104c8565b50505050925081805461058690610c1a565b80601f01602080910402602001604051908101604052809291908181526020018280546105b290610c1a565b80156105ff5780601f106105d4576101008083540402835291602001916105ff565b820191906000526020600020905b8154815290600101906020018083116105e257829003601f168201915b505050505091509b509b509b509b509b50505050505050509295509295909350565b600061062e82600061072f565b92915050565b60606000838360405160200161064b929190610c55565b60408051808303601f19018152919052949350505050565b6000806000848460405160200161067b929190610c84565b60408051601f19818403018152908290528051909250906020818382860160006103e8600019f16106ab57600080fd5b60208101604052519695505050505050565b6060600082126106dc57604051806020016040528060008152506106f7565b604051806040016040528060018152602001602d60f81b8152505b61070861070384610759565b610770565b604051602001610719929190610c55565b6040516020818303038152906040529050919050565b60008163ffffffff16836000015163ffffffff1614156107515750600161062e565b50600061062e565b60008082121561076c578160000361062e565b5090565b6060600061077d8361080d565b600101905060008167ffffffffffffffff81111561079d5761079d610975565b6040519080825280601f01601f1916602001820160405280156107c7576020820181803683370190505b5090508181016020015b600019016f181899199a1a9b1b9c1cb0b131b232b360811b600a86061a8153600a850494508461080057610805565b6107d1565b509392505050565b60008072184f03e93ff9f4daa797ed6e38ed64bf6a1f0160401b831061084c5772184f03e93ff9f4daa797ed6e38ed64bf6a1f0160401b830492506040015b6d04ee2d6d415b85acef81000000008310610878576d04ee2d6d415b85acef8100000000830492506020015b662386f26fc10000831061089657662386f26fc10000830492506010015b6305f5e10083106108ae576305f5e100830492506008015b61271083106108c257612710830492506004015b606483106108d4576064830492506002015b600a831061062e5760010192915050565b8280546108f190610c1a565b90600052602060002090601f0160209004810192826109135760008555610959565b82601f1061092c57805160ff1916838001178555610959565b82800160010185558215610959579182015b8281111561095957825182559160200191906001019061093e565b5061076c9291505b8082111561076c5760008155600101610961565b634e487b7160e01b600052604160045260246000fd5b600082601f83011261099c57600080fd5b813567ffffffffffffffff808211156109b7576109b7610975565b604051601f8301601f19908116603f011681019082821181831017156109df576109df610975565b816040528381528660208588010111156109f857600080fd5b836020870160208301376000602085830101528094505050505092915050565b60008060408385031215610a2b57600080fd5b823567ffffffffffffffff80821115610a4357600080fd5b610a4f8683870161098b565b93506020850135915080821115610a6557600080fd5b50610a728582860161098b565b9150509250929050565b60005b83811015610a97578181015183820152602001610a7f565b83811115610aa6576000848401525b50505050565b60008151808452610ac4816020860160208601610a7c565b601f01601f19169290920160200192915050565b60a081526000610aeb60a0830188610aac565b602083820381850152610afe8289610aac565b915083820360408501528187518084528284019150828160051b850101838a0160005b83811015610b4f57601f19878403018552610b3d838351610aac565b94860194925090850190600101610b21565b50508681036060880152610b63818a610aac565b95505050505050610b78608083018415159052565b9695505050505050565b634e487b7160e01b600052603260045260246000fd5b634e487b7160e01b600052601160045260246000fd5b60008160070b8360070b6000821282677fffffffffffffff03821381151615610bd957610bd9610b98565b82677fffffffffffffff19038212811615610bf657610bf6610b98565b50019392505050565b6000600019821415610c1357610c13610b98565b5060010190565b600181811c90821680610c2e57607f821691505b60208210811415610c4f57634e487b7160e01b600052602260045260246000fd5b50919050565b60008351610c67818460208801610a7c565b835190830190610c7b818360208801610a7c565b01949350505050565b604081526000610c976040830185610aac565b8281036020840152610ca98185610aac565b9594505050505056fe2f646174612f7075626c69635f6d6574726963732f666f6c6c6f776572735f636f756e74687474703a2f2f6c6f63616c686f73743a31393532372f322f75736572732f62792f757365726e616d652f22207d2c207b2022737263223a2022246861735f776562335f6163636f756e74222c20226f70223a20223c3d222c2022647374223a202268747470733a2f2f7261772e67697468756275736572636f6e74656e742e636f6d2f6c6974656e7472792f76632d6a736f6e736368656d612f6d61696e2f646973742f736368656d61732f312d62617369632d6964656e746974792d766572696669636174696f6e2f312d302d302e6a736f6e7b22616e64223a205b7b2022737263223a202224746f74616c5f666f6c6c6f77657273222c20226f70223a20223e222c2022647374223a2022a2646970667358221220226265c3843e74b720f06908722a1a83a46b8ebaf5f73ca74df0b64924b45d0b64736f6c634300080b0033").unwrap()
		);
		InMemorySmartContractRepo { map }
	}
}

impl Default for InMemorySmartContractRepo {
	fn default() -> Self {
		Self::new()
	}
}

impl SmartContractRepository for InMemorySmartContractRepo {
	fn get(&self, id: &H160) -> Option<Vec<u8>> {
		self.map.get(id).cloned()
	}
}

fn hash(a: u64) -> H160 {
	H160::from_low_u64_be(a)
}
