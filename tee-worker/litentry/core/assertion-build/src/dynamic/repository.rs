// Copyright 2020-2024 Trust Computing GmbH.
// This file is part of Litentry.
//
// Litentry is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// Litentry is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with Litentry.  If not, see <https://www.gnu.org/licenses/>.

#[cfg(all(feature = "std", feature = "sgx"))]
compile_error!("feature \"std\" and feature \"sgx\" cannot be enabled at the same time");

#[cfg(all(not(feature = "std"), feature = "sgx"))]
extern crate sgx_tstd as std;

#[cfg(all(not(feature = "std"), feature = "sgx"))]
extern crate hex_sgx as hex;

use primitive_types::H160;
use std::{collections::HashMap, vec::Vec};

pub trait SmartContractRepository {
	fn get(&self, id: &H160) -> Option<Vec<u8>>;
}

pub struct InMemorySmartContractRepo {
	map: HashMap<H160, Vec<u8>>,
}

impl InMemorySmartContractRepo {
	pub fn new() -> Self {
		let mut map = HashMap::new();
		//a1
		map.insert(
            hash(0),
            hex::decode("608060405234801561001057600080fd5b50610ba3806100206000396000f3fe608060405234801561001057600080fd5b50600436106100415760003560e01c806309c5eabe14610046578063a72fb55e14610072578063fb86fbf214610092575b600080fd5b61005961005436600461059c565b6100b5565b6040516100699493929190610635565b60405180910390f35b6100856100803660046106c7565b6100ec565b604051610069919061072b565b6100a56100a036600461077e565b610119565b6040519015158152602001610069565b6060806060600080858060200190518101906100d191906108f0565b90506100dc81610126565b9450945094509450509193509193565b60608282604051602001610101929190610a49565b60405160208183030381529060405290505b92915050565b6000610113826004610358565b6060806060600080604051806080016040528060458152602001610af260459139604080518082018252601b81527f4261736963204964656e7469747920566572696669636174696f6e000000000060208083019190915260008054600181018255818052845160608101909552603780865295965092947f290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e5639093019390929091610b379083013980516101e1939250602090910190610415565b5060008080805b8a5181101561025f576102138b828151811061020657610206610a77565b6020026020010151610382565b15610221576001915061024d565b6102438b828151811061023657610236610a77565b60200260200101516103ab565b1561024d57600192505b8061025781610a8d565b9150506101e8565b5080801561026a5750815b9250848460008581805480602002602001604051908101604052809291908181526020016000905b8282101561033e5783829060005260206000200180546102b190610ab6565b80601f01602080910402602001604051908101604052809291908181526020018280546102dd90610ab6565b801561032a5780601f106102ff5761010080835404028352916020019161032a565b820191906000526020600020905b81548152906001019060200180831161030d57829003601f168201915b505050505081526020019060010190610292565b505050509150985098509850985050505050509193509193565b60008163ffffffff16836000015163ffffffff16141561037a57506001610113565b506000610113565b600061038d826103d4565b8061039c575061039c826103e1565b806101135750610113826103ee565b60006103b6826103fb565b806103c557506103c582610119565b80610113575061011382610408565b6000610113826000610358565b6000610113826001610358565b6000610113826002610358565b6000610113826003610358565b6000610113826005610358565b82805461042190610ab6565b90600052602060002090601f0160209004810192826104435760008555610489565b82601f1061045c57805160ff1916838001178555610489565b82800160010185558215610489579182015b8281111561048957825182559160200191906001019061046e565b50610495929150610499565b5090565b5b80821115610495576000815560010161049a565b634e487b7160e01b600052604160045260246000fd5b6040516060810167ffffffffffffffff811182821017156104e7576104e76104ae565b60405290565b604051601f8201601f1916810167ffffffffffffffff81118282101715610516576105166104ae565b604052919050565b600067ffffffffffffffff821115610538576105386104ae565b50601f01601f191660200190565b600082601f83011261055757600080fd5b813561056a6105658261051e565b6104ed565b81815284602083860101111561057f57600080fd5b816020850160208301376000918101602001919091529392505050565b6000602082840312156105ae57600080fd5b813567ffffffffffffffff8111156105c557600080fd5b6105d184828501610546565b949350505050565b60005b838110156105f45781810151838201526020016105dc565b83811115610603576000848401525b50505050565b600081518084526106218160208601602086016105d9565b601f01601f19169290920160200192915050565b6080815260006106486080830187610609565b60208382038185015261065b8288610609565b915083820360408501528186518084528284019150828160051b85010183890160005b838110156106ac57601f1987840301855261069a838351610609565b9486019492509085019060010161067e565b50508095505050505050821515606083015295945050505050565b600080604083850312156106da57600080fd5b823567ffffffffffffffff808211156106f257600080fd5b6106fe86838701610546565b9350602085013591508082111561071457600080fd5b5061072185828601610546565b9150509250929050565b60208152600061073e6020830184610609565b9392505050565b63ffffffff8116811461075757600080fd5b50565b600067ffffffffffffffff821115610774576107746104ae565b5060051b60200190565b6000602080838503121561079157600080fd5b823567ffffffffffffffff808211156107a957600080fd5b90840190606082870312156107bd57600080fd5b6107c56104c4565b82356107d081610745565b815282840135828111156107e357600080fd5b6107ef88828601610546565b858301525060408301358281111561080657600080fd5b80840193505086601f84011261081b57600080fd5b8235915061082b6105658361075a565b82815260059290921b8301840191848101908884111561084a57600080fd5b938501935b8385101561087157843561086281610745565b8252938501939085019061084f565b6040830152509695505050505050565b600082601f83011261089257600080fd5b815160206108a26105658361075a565b82815260059290921b840181019181810190868411156108c157600080fd5b8286015b848110156108e55780516108d881610745565b83529183019183016108c5565b509695505050505050565b6000602080838503121561090357600080fd5b825167ffffffffffffffff8082111561091b57600080fd5b818501915085601f83011261092f57600080fd5b815161093d6105658261075a565b81815260059190911b8301840190848101908883111561095c57600080fd5b8585015b83811015610a3c5780518581111561097757600080fd5b86016060818c03601f1901121561098e5760008081fd5b6109966104c4565b888201516109a381610745565b8152604082810151888111156109b95760008081fd5b8301603f81018e136109cb5760008081fd5b8a8101516109db6105658261051e565b8181528f848385010111156109f05760008081fd5b6109ff828e83018686016105d9565b848d01525050606083015188811115610a185760008081fd5b610a268e8c83870101610881565b9183019190915250845250918601918601610960565b5098975050505050505050565b604081526000610a5c6040830185610609565b8281036020840152610a6e8185610609565b95945050505050565b634e487b7160e01b600052603260045260246000fd5b6000600019821415610aaf57634e487b7160e01b600052601160045260246000fd5b5060010190565b600181811c90821680610aca57607f821691505b60208210811415610aeb57634e487b7160e01b600052602260045260246000fd5b5091905056fe596f75277665206964656e746966696564206174206c65617374206f6e65206163636f756e742f6164647265737320696e20626f7468205765623220616e6420576562332e246861735f776562325f6163636f756e74203d3d207472756520616e6420246861735f776562335f6163636f756e74203d3d2074727565a26469706673582212209fccebb11a1d3c5e680d68eecf8b468d426a04152eda6fcc41a9bc439bd54e0c64736f6c63430008080033").unwrap()
        );
		//a20
		map.insert(
			hash(1),
			hex::decode("608060405234801561001057600080fd5b50610cb2806100206000396000f3fe608060405234801561001057600080fd5b50600436106100415760003560e01c806309c5eabe14610046578063a72fb55e14610072578063fb86fbf214610092575b600080fd5b6100596100543660046105d3565b6100b5565b604051610069949392919061066c565b60405180910390f35b6100856100803660046106fe565b6100ec565b6040516100699190610762565b6100a56100a03660046107b5565b610119565b6040519015158152602001610069565b6060806060600080858060200190518101906100d19190610927565b90506100dc81610126565b9450945094509450509193509193565b60608282604051602001610101929190610a80565b60405160208183030381529060405290505b92915050565b60006101138260046103bc565b60608060606000806040518060c0016040528060868152602001610baf60869139905060006040518060400160405280601c81526020017f49444875622045564d2056657273696f6e204561726c79204269726400000000815250905060405180604001604052806013815260200172246861735f6a6f696e6564203d3d207472756560681b815250600080815481106101c2576101c2610aae565b9060005260206000200190805190602001906101df92919061044c565b506000805b88518110156102d15761020f89828151811061020257610202610aae565b60200260200101516103e6565b156102665760006040518060c0016040528060868152602001610b296086913960408051808201909152600a8152690bda185cd29bda5b995960b21b602082015290915061025d82826103f3565b935050506102b4565b6000604051806080016040528060488152602001610c356048913960408051808201909152600a8152690bda185cd29bda5b995960b21b60208201529091506102af82826103f3565b935050505b81156102bf576102d1565b806102c981610ac4565b9150506101e4565b50828260008381805480602002602001604051908101604052809291908181526020016000905b828210156103a457838290600052602060002001805461031790610aed565b80601f016020809104026020016040519081016040528092919081815260200182805461034390610aed565b80156103905780601f1061036557610100808354040283529160200191610390565b820191906000526020600020905b81548152906001019060200180831161037357829003601f168201915b5050505050815260200190600101906102f8565b50505050915096509650965096505050509193509193565b60008163ffffffff16836000015163ffffffff1614156103de57506001610113565b506000610113565b60006101138260006103bc565b6000806000848460405160200161040b929190610a80565b60408051601f19818403018152908290528051909250906020818382860160006003600019f161043a57600080fd5b60208101604052519695505050505050565b82805461045890610aed565b90600052602060002090601f01602090048101928261047a57600085556104c0565b82601f1061049357805160ff19168380011785556104c0565b828001600101855582156104c0579182015b828111156104c05782518255916020019190600101906104a5565b506104cc9291506104d0565b5090565b5b808211156104cc57600081556001016104d1565b634e487b7160e01b600052604160045260246000fd5b6040516060810167ffffffffffffffff8111828210171561051e5761051e6104e5565b60405290565b604051601f8201601f1916810167ffffffffffffffff8111828210171561054d5761054d6104e5565b604052919050565b600067ffffffffffffffff82111561056f5761056f6104e5565b50601f01601f191660200190565b600082601f83011261058e57600080fd5b81356105a161059c82610555565b610524565b8181528460208386010111156105b657600080fd5b816020850160208301376000918101602001919091529392505050565b6000602082840312156105e557600080fd5b813567ffffffffffffffff8111156105fc57600080fd5b6106088482850161057d565b949350505050565b60005b8381101561062b578181015183820152602001610613565b8381111561063a576000848401525b50505050565b60008151808452610658816020860160208601610610565b601f01601f19169290920160200192915050565b60808152600061067f6080830187610640565b6020838203818501526106928288610640565b915083820360408501528186518084528284019150828160051b85010183890160005b838110156106e357601f198784030185526106d1838351610640565b948601949250908501906001016106b5565b50508095505050505050821515606083015295945050505050565b6000806040838503121561071157600080fd5b823567ffffffffffffffff8082111561072957600080fd5b6107358683870161057d565b9350602085013591508082111561074b57600080fd5b506107588582860161057d565b9150509250929050565b6020815260006107756020830184610640565b9392505050565b63ffffffff8116811461078e57600080fd5b50565b600067ffffffffffffffff8211156107ab576107ab6104e5565b5060051b60200190565b600060208083850312156107c857600080fd5b823567ffffffffffffffff808211156107e057600080fd5b90840190606082870312156107f457600080fd5b6107fc6104fb565b82356108078161077c565b8152828401358281111561081a57600080fd5b6108268882860161057d565b858301525060408301358281111561083d57600080fd5b80840193505086601f84011261085257600080fd5b8235915061086261059c83610791565b82815260059290921b8301840191848101908884111561088157600080fd5b938501935b838510156108a85784356108998161077c565b82529385019390850190610886565b6040830152509695505050505050565b600082601f8301126108c957600080fd5b815160206108d961059c83610791565b82815260059290921b840181019181810190868411156108f857600080fd5b8286015b8481101561091c57805161090f8161077c565b83529183019183016108fc565b509695505050505050565b6000602080838503121561093a57600080fd5b825167ffffffffffffffff8082111561095257600080fd5b818501915085601f83011261096657600080fd5b815161097461059c82610791565b81815260059190911b8301840190848101908883111561099357600080fd5b8585015b83811015610a73578051858111156109ae57600080fd5b86016060818c03601f190112156109c55760008081fd5b6109cd6104fb565b888201516109da8161077c565b8152604082810151888111156109f05760008081fd5b8301603f81018e13610a025760008081fd5b8a810151610a1261059c82610555565b8181528f84838501011115610a275760008081fd5b610a36828e8301868601610610565b848d01525050606083015188811115610a4f5760008081fd5b610a5d8e8c838701016108b8565b9183019190915250845250918601918601610997565b5098975050505050505050565b604081526000610a936040830185610640565b8281036020840152610aa58185610640565b95945050505050565b634e487b7160e01b600052603260045260246000fd5b6000600019821415610ae657634e487b7160e01b600052601160045260246000fd5b5060010190565b600181811c90821680610b0157607f821691505b60208210811415610b2257634e487b7160e01b600052602260045260246000fd5b5091905056fe687474703a2f2f6c6f63616c686f73743a31393532372f6576656e74732f646f65732d757365722d6a6f696e65642d65766d2d63616d706169676e3f6163636f756e743d307864343335393363373135666464333163363131343161626430346139396664363832326338353538383534636364653339613536383465376135366461323764546865207573657220697320616e206561726c7920626972642075736572206f6620746865204964656e746974794875622045564d2076657273696f6e20616e64206861732067656e657261746564206174206c6561737420312063726564656e7469616c20647572696e672032303233204175672031347468207e2041756720323173742e687474703a2f2f6c6f63616c686f73743a31393532372f6576656e74732f646f65732d757365722d6a6f696e65642d65766d2d63616d706169676e3f6163636f756e743d74657374a2646970667358221220f1a80c31bd194b7e77eef695689c4744058f876dca368b751fd015069b67b75e64736f6c63430008080033").unwrap()
		);
		// is age over 50
		map.insert(
            hash(2),
            hex::decode("608060405234801561001057600080fd5b5061063d806100206000396000f3fe608060405234801561001057600080fd5b50600436106100365760003560e01c806309c5eabe1461003b578063c66e70f014610067575b600080fd5b61004e6100493660046102f2565b61008a565b60405161005e949392919061038b565b60405180910390f35b61007a6100753660046103ed565b6100c1565b604051901515815260200161005e565b6060806060600080858060200190518101906100a6919061046d565b90506100b1816100e6565b9450945094509450509193509193565b6000816000015163ffffffff16600414156100de57506001919050565b506000919050565b60608060606000806040518060600160405280603181526020016105b46031913990506000604051806040016040528060148152602001732f646174612f332f656d706c6f7965655f61676560601b815250905060006040518060600160405280602381526020016105e560239139604080518082018252600a81526904973206f7665722035360b41b602080830191909152825180840190935260088352670616765203e2035360c41b908301529192506000806101a587876101d3565b905060328160070b13156101bc57600191506101c1565b600091505b50929a91995097509095509350505050565b60405160009081908385016020828288866002600019f16101f357600080fd5b506020810160405251949350505050565b634e487b7160e01b600052604160045260246000fd5b6040805190810167ffffffffffffffff8111828210171561023d5761023d610204565b60405290565b604051601f8201601f1916810167ffffffffffffffff8111828210171561026c5761026c610204565b604052919050565b600067ffffffffffffffff82111561028e5761028e610204565b50601f01601f191660200190565b600082601f8301126102ad57600080fd5b81356102c06102bb82610274565b610243565b8181528460208386010111156102d557600080fd5b816020850160208301376000918101602001919091529392505050565b60006020828403121561030457600080fd5b813567ffffffffffffffff81111561031b57600080fd5b6103278482850161029c565b949350505050565b60005b8381101561034a578181015183820152602001610332565b83811115610359576000848401525b50505050565b6000815180845261037781602086016020860161032f565b601f01601f19169290920160200192915050565b60808152600061039e608083018761035f565b82810360208401526103b0818761035f565b905082810360408401526103c4818661035f565b915050821515606083015295945050505050565b63ffffffff811681146103ea57600080fd5b50565b6000602082840312156103ff57600080fd5b813567ffffffffffffffff8082111561041757600080fd5b908301906040828603121561042b57600080fd5b61043361021a565b823561043e816103d8565b815260208301358281111561045257600080fd5b61045e8782860161029c565b60208301525095945050505050565b6000602080838503121561048057600080fd5b825167ffffffffffffffff8082111561049857600080fd5b818501915085601f8301126104ac57600080fd5b8151818111156104be576104be610204565b8060051b6104cd858201610243565b91825283810185019185810190898411156104e757600080fd5b86860192505b838310156105a6578251858111156105055760008081fd5b86016040818c03601f190181131561051d5760008081fd5b61052561021a565b89830151610532816103d8565b815282820151888111156105465760008081fd5b8084019350508c603f84011261055c5760008081fd5b8983015161056c6102bb82610274565b8181528e848387010111156105815760008081fd5b610590828d830186880161032f565b828c0152508452505091860191908601906104ed565b999850505050505050505056fe68747470733a2f2f64756d6d792e726573746170696578616d706c652e636f6d2f6170692f76312f656d706c6f7965657349732074686520656d706c6f796565206f766572203530207965617273206f6c64203fa26469706673582212209afbbff9c7067b373d283c1dbf0c57514188d257106c6e490b56ad72047a5cfa64736f6c63430008080033").unwrap()
        );
		InMemorySmartContractRepo { map }
	}
}

impl Default for InMemorySmartContractRepo {
	fn default() -> Self {
		Self::new()
	}
}

impl SmartContractRepository for InMemorySmartContractRepo {
	fn get(&self, id: &H160) -> Option<Vec<u8>> {
		self.map.get(id).cloned()
	}
}

fn hash(a: u64) -> H160 {
	H160::from_low_u64_be(a)
}
